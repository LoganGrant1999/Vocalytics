sequenceDiagram
    actor User
    participant Browser
    participant React as React App
    participant API as Fastify API
    participant Auth as auth.ts
    participant DB as Supabase

    Note over User,DB: User Registration Flow

    User->>Browser: Fill registration form
    Browser->>React: Submit form
    React->>API: POST /auth/register<br/>{email, password, name}
    API->>Auth: registerHandler()
    Auth->>DB: Check if email exists
    DB-->>Auth: No duplicate
    Auth->>Auth: bcrypt.hash(password)
    Auth->>DB: INSERT INTO profiles
    DB-->>Auth: User created
    Auth->>Auth: generateToken(userId, email, tier)
    Auth->>API: Set HTTP-only cookie
    API-->>React: {user: {...}}
    React->>React: setUser(user)
    React-->>Browser: Navigate to /connect

    Note over User,DB: User Login Flow

    User->>Browser: Enter credentials
    Browser->>React: Submit login
    React->>API: POST /auth/login<br/>{email, password}
    API->>Auth: loginHandler()
    Auth->>DB: SELECT * FROM profiles<br/>WHERE email = ?
    DB-->>Auth: User found
    Auth->>Auth: bcrypt.compare(password, hash)
    Auth->>Auth: Valid âœ“
    Auth->>Auth: generateToken()
    Auth->>API: Set HTTP-only cookie
    API-->>React: {user: {...}}
    React->>React: setUser(user)
    React-->>Browser: Navigate to /app/dashboard

    Note over User,DB: Subsequent Requests

    User->>Browser: Load page
    Browser->>React: Component mount
    React->>API: GET /auth/me<br/>(Cookie: vocalytics_token)
    API->>Auth: verifyToken(cookie)
    Auth->>Auth: jwt.verify(token)
    Auth->>DB: SELECT * FROM profiles<br/>WHERE id = userId
    DB-->>Auth: User + quota data
    Auth-->>API: {user, quota}
    API-->>React: User data
    React->>React: Update context
    React-->>Browser: Render authenticated UI
